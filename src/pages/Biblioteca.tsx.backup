import { useState, useMemo, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  Folder, ChevronRight, Grid3X3, List as ListIcon, Search, 
  FileText, Eye, Download, Share2, Trash2, X, Scan, FileSearch,
  BookOpen, Plus, Star, Lock, AlertCircle, CheckCircle, Upload,
  Edit3, Settings, Copy, Check, FileEdit, Send,
  Scale, FileSignature, Pen
} from 'lucide-react';
import { CompressButton } from '@/components/compression/CompressButton';
import { AppLayout } from '@/components/layout/AppLayout';
import { SignatureModal, useSignature } from '@/components/signature';
import { folderStructure, allFiles as initialFiles, getStatusConfig, getFileStats } from '@/data/bibliotecaData';
import { useRole } from '@/hooks/useRole';
import type { UserRole } from '@/types/roles';
import LegalLibrary from '@/components/legal-library/LegalLibrary';

// Tipos
type ModalType = 'upload' | 'suggest' | 'organize' | 'share' | 'delete' | 'edit' | 'view' | 'sign' | 'request-signature' | null;

interface FileItem {
  id: number;
  name: string;
  category: string;
  subcategory: string;
  size: string;
  modified: string;
  status: 'verified' | 'fake' | 'doubt' | string;
  confidence: number;
  author: string;
  tags: string[];
  notes: string;
  type?: string;
}

// ============================================
// CONFIGURACI√ìN POR ROL
// ============================================

const getConfigPorRol = (role: UserRole) => {
  const configs: Record<UserRole, {
    title: string;
    subtitle: string;
    puedeSubir: boolean;
    puedeEliminar: boolean;
    puedeEditarMetadatos: boolean;
    puedeOrganizar: boolean;
    puedeCompartir: boolean;
    puedeSugerir: boolean;
    puedeMarcarFavoritos: boolean;
    puedeConfigurarPermisos: boolean;
    puedeOrganizarArchivo: boolean;
    categoriasVisibles: string[];
    mensajeBienvenida: string;
    accionesDisponibles: string[];
  }> = {
    super_admin: {
      title: 'Biblioteca Forense',
      subtitle: 'Gesti√≥n completa del repositorio',
      puedeSubir: true,
      puedeEliminar: true,
      puedeEditarMetadatos: true,
      puedeOrganizar: true,
      puedeCompartir: true,
      puedeSugerir: true,
      puedeMarcarFavoritos: true,
      puedeConfigurarPermisos: true,
      puedeOrganizarArchivo: true,
      categoriasVisibles: ['all', 'legislacion', 'jurisprudencia', 'doctrina', 'plantillas', 'contratos', 'formatos', 'forense'],
      mensajeBienvenida: 'Acceso total: puedes subir, organizar y gestionar todos los documentos',
      accionesDisponibles: ['ver', 'descargar', 'compartir', 'editar', 'eliminar', 'configurar']
    },
    socio: {
      title: 'Biblioteca Forense',
      subtitle: 'Repositorio completo del bufete',
      puedeSubir: true,
      puedeEliminar: true,
      puedeEditarMetadatos: true,
      puedeOrganizar: true,
      puedeCompartir: true,
      puedeSugerir: true,
      puedeMarcarFavoritos: true,
      puedeConfigurarPermisos: false,
      puedeOrganizarArchivo: false,
      categoriasVisibles: ['all', 'legislacion', 'jurisprudencia', 'doctrina', 'plantillas', 'contratos', 'formatos', 'forense'],
      mensajeBienvenida: 'Gesti√≥n completa de documentos y categor√≠as',
      accionesDisponibles: ['ver', 'descargar', 'compartir', 'editar', 'eliminar']
    },
    abogado_senior: {
      title: 'Biblioteca de Consulta',
      subtitle: 'Documentos y jurisprudencia',
      puedeSubir: false,
      puedeEliminar: false,
      puedeEditarMetadatos: false,
      puedeOrganizar: false,
      puedeCompartir: true,
      puedeSugerir: true,
      puedeMarcarFavoritos: true,
      puedeConfigurarPermisos: false,
      puedeOrganizarArchivo: false,
      categoriasVisibles: ['all', 'legislacion', 'jurisprudencia', 'doctrina', 'plantillas', 'contratos', 'formatos'],
      mensajeBienvenida: 'Consulta, descarga y comparte documentos. Marca tus favoritos',
      accionesDisponibles: ['ver', 'descargar', 'compartir', 'favorito', 'sugerir']
    },
    abogado_junior: {
      title: 'Biblioteca de Consulta',
      subtitle: 'Recursos para tus casos',
      puedeSubir: false,
      puedeEliminar: false,
      puedeEditarMetadatos: false,
      puedeOrganizar: false,
      puedeCompartir: true,
      puedeSugerir: true,
      puedeMarcarFavoritos: true,
      puedeConfigurarPermisos: false,
      puedeOrganizarArchivo: false,
      categoriasVisibles: ['all', 'legislacion', 'jurisprudencia', 'doctrina', 'plantillas', 'contratos', 'formatos'],
      mensajeBienvenida: 'Consulta documentos y plantillas para tus casos',
      accionesDisponibles: ['ver', 'descargar', 'compartir', 'favorito', 'sugerir']
    },
    paralegal: {
      title: 'Biblioteca de Formatos',
      subtitle: 'Plantillas y documentos de referencia',
      puedeSubir: false,
      puedeEliminar: false,
      puedeEditarMetadatos: false,
      puedeOrganizar: false,
      puedeCompartir: false,
      puedeSugerir: false,
      puedeMarcarFavoritos: false,
      puedeConfigurarPermisos: false,
      puedeOrganizarArchivo: false,
      categoriasVisibles: ['all', 'plantillas', 'formatos', 'legislacion'],
      mensajeBienvenida: 'Acceso a formatos y plantillas para tu trabajo',
      accionesDisponibles: ['ver', 'descargar', 'usar']
    },
    secretario: {
      title: 'Biblioteca Documental',
      subtitle: 'Formatos y organizaci√≥n de archivo',
      puedeSubir: false,
      puedeEliminar: false,
      puedeEditarMetadatos: false,
      puedeOrganizar: false,
      puedeCompartir: false,
      puedeSugerir: false,
      puedeMarcarFavoritos: false,
      puedeConfigurarPermisos: false,
      puedeOrganizarArchivo: true,
      categoriasVisibles: ['all', 'plantillas', 'formatos', 'legislacion'],
      mensajeBienvenida: 'Consulta formatos y colabora en la organizaci√≥n del archivo',
      accionesDisponibles: ['ver', 'descargar', 'organizar']
    },
    administrador: {
      title: 'Biblioteca Administrativa',
      subtitle: 'Documentos de gesti√≥n',
      puedeSubir: false,
      puedeEliminar: false,
      puedeEditarMetadatos: false,
      puedeOrganizar: false,
      puedeCompartir: true,
      puedeSugerir: false,
      puedeMarcarFavoritos: false,
      puedeConfigurarPermisos: false,
      puedeOrganizarArchivo: false,
      categoriasVisibles: ['all', 'contratos', 'plantillas', 'legislacion'],
      mensajeBienvenida: 'Acceso a documentos administrativos y contratos tipo',
      accionesDisponibles: ['ver', 'descargar', 'compartir']
    },
    contador: {
      title: 'Biblioteca Administrativa',
      subtitle: 'Documentos fiscales y contratos',
      puedeSubir: false,
      puedeEliminar: false,
      puedeEditarMetadatos: false,
      puedeOrganizar: false,
      puedeCompartir: true,
      puedeSugerir: false,
      puedeMarcarFavoritos: false,
      puedeConfigurarPermisos: false,
      puedeOrganizarArchivo: false,
      categoriasVisibles: ['all', 'contratos', 'plantillas'],
      mensajeBienvenida: 'Acceso a plantillas de contratos y documentos administrativos',
      accionesDisponibles: ['ver', 'descargar', 'compartir']
    },
    recepcionista: {
      title: 'Sin Acceso',
      subtitle: 'No tienes permisos para esta secci√≥n',
      puedeSubir: false,
      puedeEliminar: false,
      puedeEditarMetadatos: false,
      puedeOrganizar: false,
      puedeCompartir: false,
      puedeSugerir: false,
      puedeMarcarFavoritos: false,
      puedeConfigurarPermisos: false,
      puedeOrganizarArchivo: false,
      categoriasVisibles: [],
      mensajeBienvenida: 'Contacta al administrador si necesitas acceso a documentos',
      accionesDisponibles: []
    }
  };
  
  return configs[role] || configs.abogado_junior;
};

// Componente para acceso denegado
const AccesoDenegado = () => (
  <div className="flex flex-col items-center justify-center min-h-[60vh] p-8">
    <div className="w-24 h-24 bg-theme-tertiary rounded-full flex items-center justify-center mb-6">
      <Lock className="w-12 h-12 text-theme-tertiary" />
    </div>
    <h2 className="text-2xl font-bold text-theme-primary mb-2">Acceso Restringido</h2>
    <p className="text-theme-tertiary text-center max-w-md">
      Tu rol no tiene permisos para acceder a la biblioteca. 
      Si necesitas consultar documentos, contacta a tu supervisor.
    </p>
  </div>
);

type LibraryTab = 'interna' | 'oficial';

export default function Biblioteca() {
  const { role, roleConfig } = useRole();
  const signature = useSignature(role, 'usuario@bufete.com');
  const [activeTab, setActiveTab] = useState<LibraryTab>('interna');
  const [selectedFolder, setSelectedFolder] = useState<string | null>(null);
  const [selectedSubfolder, setSelectedSubfolder] = useState<string | null>(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');
  const [selectedFile, setSelectedFile] = useState<FileItem | null>(null);
  const [favoritos, setFavoritos] = useState<number[]>([]);
  const [allFiles, setAllFiles] = useState<FileItem[]>(initialFiles as FileItem[]);
  const [activeModal, setActiveModal] = useState<ModalType>(null);
  const [toast, setToast] = useState<{message: string; type: 'success' | 'info' | 'error'} | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // Form states
  const [uploadForm, setUploadForm] = useState({
    name: '',
    category: 'legislacion',
    tags: '',
    file: null as File | null
  });
  
  const [suggestForm, setSuggestForm] = useState({
    title: '',
    description: '',
    category: 'legislacion'
  });
  
  const [editForm, setEditForm] = useState({
    name: '',
    tags: '',
    notes: ''
  });

  const [shareEmail, setShareEmail] = useState('');
  const [copiedLink, setCopiedLink] = useState(false);
  
  // Estado para firma electr√≥nica
  const [signatureModalOpen, setSignatureModalOpen] = useState(false);
  const [signatureMode, setSignatureMode] = useState<'sign' | 'request'>('request');

  const showToast = (message: string, type: 'success' | 'info' | 'error' = 'success') => {
    setToast({ message, type });
    setTimeout(() => setToast(null), 3000);
  };

  // Obtener configuraci√≥n seg√∫n el rol
  const config = useMemo(() => getConfigPorRol(role), [role]);

  // Filtrar archivos seg√∫n b√∫squeda y carpetas
  const filteredFiles = useMemo(() => {
    // Filtrar por categor√≠as visibles del rol
    let files = allFiles;
    
    // Si no tiene acceso a forense, filtrar esos documentos
    if (!config.categoriasVisibles.includes('forense')) {
      files = files.filter(f => f.category !== 'forense');
    }
    
    return files.filter(file => {
      const matchesSearch = file.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                           file.notes.toLowerCase().includes(searchQuery.toLowerCase()) ||
                           file.tags.some(tag => tag.toLowerCase().includes(searchQuery.toLowerCase()));
      const matchesFolder = !selectedFolder || file.category === selectedFolder;
      const matchesSubfolder = !selectedSubfolder || file.subcategory === selectedSubfolder;
      return matchesSearch && matchesFolder && matchesSubfolder;
    });
  }, [allFiles, searchQuery, selectedFolder, selectedSubfolder, config.categoriasVisibles]);

  // Handlers
  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setUploadForm({ ...uploadForm, file, name: file.name });
    }
  };

  const handleUpload = () => {
    if (!uploadForm.name || !uploadForm.file) {
      showToast('Por favor selecciona un archivo', 'error');
      return;
    }
    
    const newFile: FileItem = {
      id: Date.now(),
      name: uploadForm.name,
      category: uploadForm.category,
      subcategory: 'general',
      size: `${(uploadForm.file.size / (1024 * 1024)).toFixed(1)} MB`,
      modified: new Date().toLocaleDateString('es-ES'),
      status: 'verified',
      confidence: 95,
      author: 'Usuario Actual',
      tags: uploadForm.tags.split(',').map(t => t.trim()).filter(Boolean),
      notes: 'Documento subido recientemente'
    };
    
    setAllFiles([newFile, ...allFiles]);
    setUploadForm({ name: '', category: 'legislacion', tags: '', file: null });
    setActiveModal(null);
    showToast('Documento subido correctamente');
  };

  const handleSuggest = () => {
    if (!suggestForm.title) {
      showToast('Por favor ingresa el t√≠tulo del documento', 'error');
      return;
    }
    showToast('Sugerencia enviada para revisi√≥n', 'success');
    setSuggestForm({ title: '', description: '', category: 'legislacion' });
    setActiveModal(null);
  };

  const handleDelete = () => {
    if (!selectedFile) return;
    if (confirm(`¬øEst√°s seguro de eliminar "${selectedFile.name}"?`)) {
      setAllFiles(allFiles.filter(f => f.id !== selectedFile.id));
      setSelectedFile(null);
      setActiveModal(null);
      showToast('Documento eliminado correctamente');
    }
  };

  const handleDownload = (file: FileItem) => {
    showToast(`Descargando ${file.name}...`, 'info');
    setTimeout(() => {
      showToast('Descarga completada');
    }, 1500);
  };

  const handleShare = () => {
    if (!shareEmail && !copiedLink) {
      showToast('Por favor ingresa un email o copia el enlace', 'error');
      return;
    }
    showToast(copiedLink ? 'Enlace copiado al portapapeles' : 'Documento compartido correctamente');
    setShareEmail('');
    setCopiedLink(false);
    setActiveModal(null);
  };

  const handleCopyLink = () => {
    setCopiedLink(true);
    navigator.clipboard.writeText(`https://bufete.com/docs/${selectedFile?.id}`);
    showToast('Enlace copiado al portapapeles');
  };

  const handleEdit = () => {
    if (!selectedFile) return;
    
    setAllFiles(allFiles.map(f => 
      f.id === selectedFile.id 
        ? { ...f, name: editForm.name || f.name, tags: editForm.tags.split(',').map(t => t.trim()).filter(Boolean) || f.tags, notes: editForm.notes || f.notes }
        : f
    ));
    
    setSelectedFile({ ...selectedFile, name: editForm.name || selectedFile.name, tags: editForm.tags.split(',').map(t => t.trim()).filter(Boolean) || selectedFile.tags, notes: editForm.notes || selectedFile.notes });
    setActiveModal(null);
    showToast('Documento actualizado correctamente');
  };

  const handleOrganize = () => {
    showToast('Archivo organizado correctamente', 'success');
    setActiveModal(null);
  };

  const openEditModal = () => {
    if (selectedFile) {
      setEditForm({
        name: selectedFile.name,
        tags: selectedFile.tags.join(', '),
        notes: selectedFile.notes
      });
      setActiveModal('edit');
    }
  };

  // Estad√≠sticas ajustadas seg√∫n el rol
  const stats = useMemo(() => {
    const baseStats = getFileStats();
    if (!config.categoriasVisibles.includes('forense')) {
      // Ajustar estad√≠sticas si no ve documentos forenses
      return {
        ...baseStats,
        total: filteredFiles.length,
        verified: Math.floor(baseStats.verified * 0.7),
        fake: Math.floor(baseStats.fake * 0.3),
        doubt: Math.floor(baseStats.doubt * 0.5)
      };
    }
    return baseStats;
  }, [config.categoriasVisibles, filteredFiles.length]);

  // Si es recepcionista, mostrar acceso denegado
  if (role === 'recepcionista') {
    return (
      <AppLayout title={config.title} subtitle={config.subtitle}>
        <AccesoDenegado />
      </AppLayout>
    );
  }

  const toggleFavorito = (fileId: number) => {
    setFavoritos(prev => 
      prev.includes(fileId) 
        ? prev.filter(id => id !== fileId)
        : [...prev, fileId]
    );
  };

  // Filtrar carpetas seg√∫n categor√≠as visibles
  const visibleFolders = folderStructure.filter(folder => 
    config.categoriasVisibles.includes('all') || 
    config.categoriasVisibles.includes(folder.id)
  );

  const headerActions = (
    <>
      {config.puedeSubir && (
        <button 
          onClick={() => setActiveModal('upload')}
          className="flex items-center gap-2 px-4 py-2 bg-amber-500 text-slate-950 font-medium rounded-xl hover:bg-amber-400 transition-colors"
        >
          <Plus className="w-4 h-4" />
          <span className="hidden lg:inline">Subir Documento</span>
        </button>
      )}
      {config.puedeSugerir && (
        <button 
          onClick={() => setActiveModal('suggest')}
          className="flex items-center gap-2 px-4 py-2 bg-slate-800 text-white font-medium rounded-xl hover:bg-slate-700 transition-colors"
        >
          <Scan className="w-4 h-4" />
          <span className="hidden lg:inline">Sugerir Documento</span>
        </button>
      )}
      {config.puedeOrganizarArchivo && (
        <button 
          onClick={() => setActiveModal('organize')}
          className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors" 
          title="Organizar archivo"
        >
          <Folder className="w-5 h-5" />
        </button>
      )}
    </>
  );

  // Si estamos en la pesta√±a de Biblioteca Legal, renderizar el componente LegalLibrary
  if (activeTab === 'oficial') {
    return (
      <AppLayout 
        title="Biblioteca"
        subtitle="Gesti√≥n documental y legislaci√≥n oficial"
      >
        {/* Tabs de navegaci√≥n */}
        <div className="px-4 pt-4">
          <div className="flex gap-2 p-1 bg-theme-secondary border border-theme rounded-xl w-fit">
            <button
              onClick={() => setActiveTab('interna')}
              className="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-theme-tertiary hover:text-theme-primary hover:bg-theme-tertiary transition-all"
            >
              <BookOpen className="w-4 h-4" />
              Biblioteca Interna
            </button>
            <button
              onClick={() => setActiveTab('oficial')}
              className="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-accent text-slate-950 transition-all"
            >
              <Scale className="w-4 h-4" />
              Legislaci√≥n Oficial
            </button>
          </div>
        </div>
        <LegalLibrary />
      </AppLayout>
    );
  }

  return (
    <AppLayout 
      title={config.title}
      subtitle={config.subtitle}
      headerActions={headerActions}
    >
      {/* Tabs de navegaci√≥n */}
      {(
        <div className="px-4 pt-4">
          <div className="flex gap-2 p-1 bg-theme-secondary border border-theme rounded-xl w-fit">
            <button
              onClick={() => setActiveTab('interna')}
              className="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-accent text-slate-950 transition-all"
            >
              <BookOpen className="w-4 h-4" />
              Biblioteca Interna
            </button>
            <button
              onClick={() => setActiveTab('oficial')}
              className="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-theme-tertiary hover:text-theme-primary hover:bg-theme-tertiary transition-all"
            >
              <Scale className="w-4 h-4" />
              Legislaci√≥n Oficial
            </button>
          </div>
        </div>
      )}

      {/* Mensaje de bienvenida seg√∫n rol */}
      <div className={`mx-4 mb-2 p-3 rounded-xl border ${roleConfig.bgColor} ${roleConfig.textColor.replace('text-', 'border-').replace('400', '500/20')}`}>
        <div className="flex items-center gap-2">
          <div className={`p-1.5 rounded-lg bg-slate-900/50`}>
            <BookOpen className={`w-4 h-4 ${roleConfig.textColor}`} />
          </div>
          <p className={`text-sm ${roleConfig.textColor}`}>{config.mensajeBienvenida}</p>
        </div>
      </div>

      <div className="flex-1 flex overflow-hidden">
        {/* Sidebar de Carpetas */}
        <div className="w-72 bg-slate-900/60 border-r border-slate-800 overflow-y-auto">
          {/* Estad√≠sticas - solo si tiene acceso a forense */}
          {config.categoriasVisibles.includes('forense') && (
            <div className="p-4 border-b border-slate-800">
              <div className="grid grid-cols-3 gap-2">
                <div className="text-center p-2 bg-emerald-500/10 rounded-lg border border-emerald-500/20">
                  <p className="text-xl font-bold text-emerald-400">{stats.verified}</p>
                  <p className="text-[10px] text-emerald-500/70 uppercase">Verif.</p>
                </div>
                <div className="text-center p-2 bg-red-500/10 rounded-lg border border-red-500/20">
                  <p className="text-xl font-bold text-red-400">{stats.fake}</p>
                  <p className="text-[10px] text-red-500/70 uppercase">Falsos</p>
                </div>
                <div className="text-center p-2 bg-amber-500/10 rounded-lg border border-amber-500/20">
                  <p className="text-xl font-bold text-amber-400">{stats.doubt}</p>
                  <p className="text-[10px] text-amber-500/70 uppercase">Dudas</p>
                </div>
              </div>
            </div>
          )}

          <div className="p-2">
            <button
              onClick={() => { setSelectedFolder(null); setSelectedSubfolder(null); }}
              className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-colors mb-2 ${
                !selectedFolder ? 'bg-amber-500/20 text-amber-500' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
              }`}
            >
              <Folder className="w-5 h-5" />
              <span className="text-sm font-medium">Todos los documentos</span>
              <span className="ml-auto text-xs text-slate-500">{stats.total}</span>
            </button>

            <div className="space-y-1">
              {visibleFolders.map((folder) => (
                <div key={folder.id}>
                  <button
                    onClick={() => setSelectedFolder(selectedFolder === folder.id ? null : folder.id)}
                    className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-colors ${
                      selectedFolder === folder.id ? 'bg-slate-800 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                    }`}
                  >
                    <folder.icon className={`w-5 h-5 ${
                      folder.color === 'blue' ? 'text-blue-500' :
                      folder.color === 'purple' ? 'text-purple-500' :
                      folder.color === 'cyan' ? 'text-cyan-500' :
                      folder.color === 'amber' ? 'text-amber-500' :
                      folder.color === 'rose' ? 'text-rose-500' :
                      'text-emerald-500'
                    }`} />
                    <span className="text-sm font-medium flex-1 text-left">{folder.name}</span>
                    <ChevronRight className={`w-4 h-4 transition-transform ${selectedFolder === folder.id ? 'rotate-90' : ''}`} />
                  </button>

                  <AnimatePresence>
                    {selectedFolder === folder.id && (
                      <motion.div
                        initial={{ height: 0, opacity: 0 }}
                        animate={{ height: 'auto', opacity: 1 }}
                        exit={{ height: 0, opacity: 0 }}
                        className="overflow-hidden"
                      >
                        <div className="pl-4 pr-2 py-1 space-y-1">
                          {folder.subfolders.map((sub) => (
                            <button
                              key={sub.id}
                              onClick={() => setSelectedSubfolder(selectedSubfolder === sub.id ? null : sub.id)}
                              className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm transition-colors ${
                                selectedSubfolder === sub.id 
                                  ? `${sub.color === 'emerald' ? 'bg-emerald-500/20 text-emerald-400' : sub.color === 'red' ? 'bg-red-500/20 text-red-400' : 'bg-amber-500/20 text-amber-400'}`
                                  : 'text-slate-500 hover:bg-slate-800 hover:text-slate-300'
                              }`}
                            >
                              <div className={`w-2 h-2 rounded-full ${
                                sub.color === 'emerald' ? 'bg-emerald-500' : sub.color === 'red' ? 'bg-red-500' : 'bg-amber-500'
                              }`} />
                              <span className="flex-1 text-left">{sub.name}</span>
                              <span className="text-xs opacity-70">{sub.count}</span>
                            </button>
                          ))}
                        </div>
                      </motion.div>
                    )}
                  </AnimatePresence>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Main Area */}
        <div className="flex-1 flex flex-col min-w-0">
          {/* Toolbar */}
          <div className="h-16 border-b border-slate-800 flex items-center justify-between px-6">
            <div className="flex items-center gap-4">
              <h2 className="text-lg font-semibold text-white">
                {selectedSubfolder 
                  ? folderStructure.find(f => f.id === selectedFolder)?.subfolders.find(s => s.id === selectedSubfolder)?.name
                  : selectedFolder 
                    ? folderStructure.find(f => f.id === selectedFolder)?.name
                    : 'Todos los documentos'
                }
              </h2>
              <span className="px-2 py-1 bg-slate-800 text-slate-400 text-xs rounded-full">
                {filteredFiles.length} archivos
              </span>
            </div>

            <div className="flex items-center gap-3">
              {/* Bot√≥n de compresi√≥n */}
              <CompressButton
                files={[]} // En implementaci√≥n real, archivos seleccionados
                defaultFilename={`Biblioteca_${new Date().toISOString().split('T')[0]}`}
                variant="secondary"
                label="üì¶ Comprimir"
                showCount={false}
              />
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" />
                <input
                  type="text"
                  placeholder="Buscar documentos..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="w-64 pl-9 pr-4 py-2 bg-slate-900 border border-slate-800 rounded-xl text-white text-sm placeholder-slate-500 focus:outline-none focus:border-amber-500 transition-colors"
                />
              </div>
              <div className="flex p-1 bg-slate-900 border border-slate-800 rounded-lg">
                <button onClick={() => setViewMode('grid')} className={`p-2 rounded-md ${viewMode === 'grid' ? 'bg-slate-700 text-white' : 'text-slate-400'}`}>
                  <Grid3X3 className="w-4 h-4" />
                </button>
                <button onClick={() => setViewMode('list')} className={`p-2 rounded-md ${viewMode === 'list' ? 'bg-slate-700 text-white' : 'text-slate-400'}`}>
                  <ListIcon className="w-4 h-4" />
                </button>
              </div>
            </div>
          </div>

          {/* Files */}
          <div className="flex-1 overflow-y-auto p-6">
            {viewMode === 'grid' ? (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {filteredFiles.map((file, index) => {
                  const statusConfig = getStatusConfig(file.status);
                  const isFavorito = favoritos.includes(file.id);
                  return (
                    <motion.div
                      key={file.id}
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      transition={{ delay: index * 0.03 }}
                      onClick={() => setSelectedFile(file)}
                      className={`p-4 bg-slate-900/60 border rounded-xl cursor-pointer transition-all hover:scale-[1.02] ${
                        selectedFile?.id === file.id ? 'border-amber-500 ring-1 ring-amber-500/50' : 'border-slate-800 hover:border-slate-700'
                      }`}
                    >
                      <div className="flex items-start gap-3 mb-3">
                        <div className={`w-12 h-12 ${statusConfig.bg} rounded-xl flex items-center justify-center border ${statusConfig.border}`}>
                          <FileText className={`w-6 h-6 ${statusConfig.color}`} />
                        </div>
                        <div className="flex-1 min-w-0">
                          <h4 className="text-sm font-medium text-white truncate" title={file.name}>
                            {file.name.length > 30 ? file.name.substring(0, 30) + '...' : file.name}
                          </h4>
                          <p className="text-xs text-slate-500 mt-1">{file.size} ‚Ä¢ {file.modified}</p>
                        </div>
                        {/* Bot√≥n de favorito para abogados */}
                        {config.puedeMarcarFavoritos && (
                          <button 
                            onClick={(e) => { e.stopPropagation(); toggleFavorito(file.id); }}
                            className={`p-1 rounded-lg transition-colors ${isFavorito ? 'text-amber-500' : 'text-slate-600 hover:text-amber-500'}`}
                          >
                            <Star className={`w-4 h-4 ${isFavorito ? 'fill-current' : ''}`} />
                          </button>
                        )}
                      </div>

                      <div className="flex items-center justify-between mb-3">
                        <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border ${statusConfig.bg} ${statusConfig.color} ${statusConfig.border}`}>
                          <span className="w-3 h-3" />
                          {statusConfig.label}
                        </span>
                        {config.categoriasVisibles.includes('forense') && (
                          <div className="flex items-center gap-1">
                            <div className="h-1.5 w-16 bg-slate-700 rounded-full overflow-hidden">
                              <div 
                                className={`h-full rounded-full ${
                                  file.confidence >= 90 ? 'bg-emerald-500' : 
                                  file.confidence >= 70 ? 'bg-amber-500' : 'bg-red-500'
                                }`}
                                style={{ width: `${file.confidence}%` }}
                              />
                            </div>
                            <span className="text-xs text-slate-500">{file.confidence}%</span>
                          </div>
                        )}
                      </div>

                      <div className="flex flex-wrap gap-1">
                        {file.tags.slice(0, 3).map((tag) => (
                          <span key={tag} className="px-2 py-0.5 bg-slate-800 text-slate-400 text-[10px] rounded-full">{tag}</span>
                        ))}
                        {file.tags.length > 3 && (
                          <span className="px-2 py-0.5 bg-slate-800 text-slate-400 text-[10px] rounded-full">+{file.tags.length - 3}</span>
                        )}
                      </div>
                    </motion.div>
                  );
                })}
              </div>
            ) : (
              <div className="space-y-2">
                {filteredFiles.map((file, index) => {
                  const statusConfig = getStatusConfig(file.status);
                  const isFavorito = favoritos.includes(file.id);
                  return (
                    <motion.div
                      key={file.id}
                      initial={{ opacity: 0, x: -20 }}
                      animate={{ opacity: 1, x: 0 }}
                      transition={{ delay: index * 0.03 }}
                      onClick={() => setSelectedFile(file)}
                      className={`flex items-center gap-4 p-4 bg-slate-900/60 border rounded-xl cursor-pointer transition-all ${
                        selectedFile?.id === file.id ? 'border-amber-500 ring-1 ring-amber-500/50' : 'border-slate-800 hover:border-slate-700'
                      }`}
                    >
                      <div className={`w-10 h-10 ${statusConfig.bg} rounded-lg flex items-center justify-center border ${statusConfig.border} flex-shrink-0`}>
                        <FileText className={`w-5 h-5 ${statusConfig.color}`} />
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-3">
                          <h4 className="text-sm font-medium text-white truncate">{file.name}</h4>
                          <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium border ${statusConfig.bg} ${statusConfig.color} ${statusConfig.border}`}>
                            {statusConfig.label}
                          </span>
                          {config.puedeMarcarFavoritos && isFavorito && (
                            <Star className="w-4 h-4 text-amber-500 fill-current" />
                          )}
                        </div>
                        <p className="text-xs text-slate-500 mt-1 truncate">{file.notes}</p>
                      </div>
                      {config.categoriasVisibles.includes('forense') && (
                        <div className="flex items-center gap-6">
                          <div className="text-right">
                            <div className="flex items-center gap-1">
                              <div className="h-1.5 w-12 bg-slate-700 rounded-full overflow-hidden">
                                <div 
                                  className={`h-full rounded-full ${
                                    file.confidence >= 90 ? 'bg-emerald-500' : 
                                    file.confidence >= 70 ? 'bg-amber-500' : 'bg-red-500'
                                  }`}
                                  style={{ width: `${file.confidence}%` }}
                                />
                              </div>
                              <span className="text-xs text-slate-500">{file.confidence}%</span>
                            </div>
                          </div>
                        </div>
                      )}
                    </motion.div>
                  );
                })}
              </div>
            )}

            {filteredFiles.length === 0 && (
              <div className="text-center py-16">
                <FileSearch className="w-16 h-16 text-slate-600 mx-auto mb-4" />
                <h3 className="text-lg font-medium text-white mb-2">No se encontraron documentos</h3>
                <p className="text-slate-400">
                  {config.puedeSubir 
                    ? 'Intenta ajustar los filtros o sube un nuevo documento'
                    : 'Intenta ajustar los filtros de b√∫squeda'}
                </p>
              </div>
            )}
          </div>
        </div>

        {/* Panel de Detalles */}
        <AnimatePresence>
          {selectedFile && (
            <motion.div
              initial={{ width: 0, opacity: 0 }}
              animate={{ width: 380, opacity: 1 }}
              exit={{ width: 0, opacity: 0 }}
              className="border-l border-slate-800 bg-slate-900/60 overflow-hidden"
            >
              <div className="h-full overflow-y-auto p-6">
                {(() => {
                  const statusConfig = getStatusConfig(selectedFile.status);
                  const isFavorito = favoritos.includes(selectedFile.id);
                  return (
                    <>
                      <div className="p-6 border-b border-slate-800">
                        <div className="flex items-start justify-between mb-4">
                          <div className={`w-16 h-16 ${statusConfig.bg} rounded-2xl flex items-center justify-center border ${statusConfig.border}`}>
                            <FileText className={`w-8 h-8 ${statusConfig.color}`} />
                          </div>
                          <button onClick={() => setSelectedFile(null)} className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg">
                            <X className="w-5 h-5" />
                          </button>
                        </div>
                        <h3 className="text-lg font-bold text-white break-all mb-2">{selectedFile.name}</h3>
                        <span className={`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium border ${statusConfig.bg} ${statusConfig.color} ${statusConfig.border}`}>
                          {statusConfig.label}
                        </span>
                        
                        {/* Indicador de favorito */}
                        {config.puedeMarcarFavoritos && (
                          <button
                            onClick={() => toggleFavorito(selectedFile.id)}
                            className={`mt-3 flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm transition-colors ${
                              isFavorito 
                                ? 'bg-amber-500/20 text-amber-500' 
                                : 'bg-slate-800 text-slate-400 hover:text-amber-500'
                            }`}
                          >
                            <Star className={`w-4 h-4 ${isFavorito ? 'fill-current' : ''}`} />
                            {isFavorito ? 'En favoritos' : 'A√±adir a favoritos'}
                          </button>
                        )}
                      </div>

                      <div className="p-6 space-y-6">
                        {/* Confianza - solo si tiene acceso a forense */}
                        {config.categoriasVisibles.includes('forense') && (
                          <div>
                            <div className="flex items-center justify-between mb-2">
                              <span className="text-sm text-slate-400">Nivel de confianza</span>
                              <span className={`text-lg font-bold ${
                                selectedFile.confidence >= 90 ? 'text-emerald-400' : 
                                selectedFile.confidence >= 70 ? 'text-amber-400' : 'text-red-400'
                              }`}>{selectedFile.confidence}%</span>
                            </div>
                            <div className="h-3 bg-slate-800 rounded-full overflow-hidden">
                              <div 
                                className={`h-full rounded-full ${
                                  selectedFile.confidence >= 90 ? 'bg-emerald-500' : 
                                  selectedFile.confidence >= 70 ? 'bg-amber-500' : 'bg-red-500'
                                }`}
                                style={{ width: `${selectedFile.confidence}%` }}
                              />
                            </div>
                          </div>
                        )}

                        <div className="space-y-3">
                          <div className="flex justify-between py-2 border-b border-slate-800">
                            <span className="text-sm text-slate-400">Tama√±o</span>
                            <span className="text-sm text-white">{selectedFile.size}</span>
                          </div>
                          <div className="flex justify-between py-2 border-b border-slate-800">
                            <span className="text-sm text-slate-400">Modificado</span>
                            <span className="text-sm text-white">{selectedFile.modified}</span>
                          </div>
                          <div className="flex justify-between py-2 border-b border-slate-800">
                            <span className="text-sm text-slate-400">Autor</span>
                            <span className="text-sm text-white">{selectedFile.author}</span>
                          </div>
                          {config.puedeOrganizarArchivo && (
                            <div className="flex justify-between py-2 border-b border-slate-800">
                              <span className="text-sm text-slate-400">Ubicaci√≥n f√≠sica</span>
                              <span className="text-sm text-white">Archivo {String(selectedFile.id).slice(-2)}</span>
                            </div>
                          )}
                        </div>

                        <div>
                          <h4 className="text-sm font-medium text-white mb-3">
                            {config.categoriasVisibles.includes('forense') 
                              ? 'Elementos de seguridad analizados' 
                              : 'Etiquetas'}
                          </h4>
                          <div className="flex flex-wrap gap-2">
                            {selectedFile.tags.map((tag) => (
                              <span key={tag} className="px-3 py-1.5 bg-slate-800 text-slate-300 text-xs rounded-lg border border-slate-700">{tag}</span>
                            ))}
                          </div>
                        </div>

                        {config.categoriasVisibles.includes('forense') && (
                          <div>
                            <h4 className="text-sm font-medium text-white mb-3">Informe forense</h4>
                            <div className="p-4 bg-slate-800/50 rounded-xl border border-slate-700">
                              <p className="text-sm text-slate-300 leading-relaxed">{selectedFile.notes}</p>
                            </div>
                          </div>
                        )}

                        <div className="grid grid-cols-2 gap-3">
                          <button 
                            onClick={() => { setActiveModal('view'); }}
                            className="flex items-center justify-center gap-2 px-4 py-2.5 bg-slate-800 text-white rounded-xl hover:bg-slate-700"
                          >
                            <Eye className="w-4 h-4" />
                            <span className="text-sm">Ver</span>
                          </button>
                          <button 
                            onClick={() => handleDownload(selectedFile)}
                            className="flex items-center justify-center gap-2 px-4 py-2.5 bg-slate-800 text-white rounded-xl hover:bg-slate-700"
                          >
                            <Download className="w-4 h-4" />
                            <span className="text-sm">Descargar</span>
                          </button>
                          {config.puedeCompartir && (
                            <button 
                              onClick={() => setActiveModal('share')}
                              className="flex items-center justify-center gap-2 px-4 py-2.5 bg-slate-800 text-white rounded-xl hover:bg-slate-700"
                            >
                              <Share2 className="w-4 h-4" />
                              <span className="text-sm">Compartir</span>
                            </button>
                          )}
                          
                          {/* Botones de firma electr√≥nica */}
                          {signature.permissions.canRequestSignatures && (
                            <button 
                              onClick={() => {
                                setSignatureMode('request');
                                setSignatureModalOpen(true);
                              }}
                              className="flex items-center justify-center gap-2 px-4 py-2.5 bg-purple-500/10 text-purple-400 rounded-xl hover:bg-purple-500/20 border border-purple-500/20"
                            >
                              <FileSignature className="w-4 h-4" />
                              <span className="text-sm">Solicitar firma</span>
                            </button>
                          )}
                          
                          {signature.permissions.canSign && (
                            <button 
                              onClick={() => {
                                setSignatureMode('sign');
                                setSignatureModalOpen(true);
                              }}
                              className="flex items-center justify-center gap-2 px-4 py-2.5 bg-emerald-500/10 text-emerald-400 rounded-xl hover:bg-emerald-500/20 border border-emerald-500/20"
                            >
                              <Pen className="w-4 h-4" />
                              <span className="text-sm">Firmar</span>
                            </button>
                          )}
                          
                          {config.puedeEditarMetadatos && (
                            <button 
                              onClick={openEditModal}
                              className="flex items-center justify-center gap-2 px-4 py-2.5 bg-blue-500/10 text-blue-400 rounded-xl hover:bg-blue-500/20 border border-blue-500/20"
                            >
                              <Edit3 className="w-4 h-4" />
                              <span className="text-sm">Editar</span>
                            </button>
                          )}
                          {config.puedeEliminar ? (
                            <button 
                              onClick={() => setActiveModal('delete')}
                              className="flex items-center justify-center gap-2 px-4 py-2.5 bg-red-500/10 text-red-400 rounded-xl hover:bg-red-500/20 border border-red-500/20"
                            >
                              <Trash2 className="w-4 h-4" />
                              <span className="text-sm">Eliminar</span>
                            </button>
                          ) : config.puedeSugerir ? (
                            <button 
                              onClick={() => setActiveModal('suggest')}
                              className="flex items-center justify-center gap-2 px-4 py-2.5 bg-amber-500/10 text-amber-400 rounded-xl hover:bg-amber-500/20 border border-amber-500/20"
                            >
                              <AlertCircle className="w-4 h-4" />
                              <span className="text-sm">Sugerir</span>
                            </button>
                          ) : null}
                        </div>
                      </div>
                    </>
                  );
                })()}
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </div>

      {/* Toast Notification */}
      <AnimatePresence>
        {toast && (
          <motion.div
            initial={{ opacity: 0, y: 50 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: 50 }}
            className={`fixed bottom-6 right-6 z-50 px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 ${
              toast.type === 'success' ? 'bg-emerald-500' : 
              toast.type === 'error' ? 'bg-red-500' : 'bg-amber-500'
            } text-slate-950 font-medium`}
          >
            {toast.type === 'success' ? <CheckCircle className="w-5 h-5" /> : 
             toast.type === 'error' ? <AlertCircle className="w-5 h-5" /> : <Scan className="w-5 h-5" />}
            {toast.message}
          </motion.div>
        )}
      </AnimatePresence>

      {/* Modal: Subir Documento */}
      <AnimatePresence>
        {activeModal === 'upload' && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
            onClick={() => setActiveModal(null)}
          >
            <motion.div
              initial={{ scale: 0.95, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.95, opacity: 0 }}
              className="bg-slate-900 border border-slate-800 rounded-2xl p-6 w-full max-w-lg"
              onClick={e => e.stopPropagation()}
            >
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-semibold text-white">Subir Documento</h3>
                <button onClick={() => setActiveModal(null)} className="p-1 text-slate-400 hover:text-white">
                  <X className="w-5 h-5" />
                </button>
              </div>
              
              <div className="space-y-4">
                <div 
                  onClick={() => fileInputRef.current?.click()}
                  className="border-2 border-dashed border-slate-700 rounded-xl p-8 text-center cursor-pointer hover:border-amber-500/50 transition-colors"
                >
                  <Upload className="w-10 h-10 text-slate-500 mx-auto mb-3" />
                  <p className="text-sm text-slate-400">
                    {uploadForm.file ? uploadForm.file.name : 'Arrastra un archivo o haz clic para seleccionar'}
                  </p>
                  <p className="text-xs text-slate-600 mt-1">M√°ximo 50MB</p>
                </div>
                <input ref={fileInputRef} type="file" onChange={handleFileSelect} className="hidden" />

                <div>
                  <label className="text-sm text-slate-400 mb-2 block">Nombre del documento</label>
                  <input
                    type="text"
                    value={uploadForm.name}
                    onChange={(e) => setUploadForm({...uploadForm, name: e.target.value})}
                    placeholder="Ej: C√≥digo Civil 2026"
                    className="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-amber-500"
                  />
                </div>

                <div>
                  <label className="text-sm text-slate-400 mb-2 block">Categor√≠a</label>
                  <select
                    value={uploadForm.category}
                    onChange={(e) => setUploadForm({...uploadForm, category: e.target.value})}
                    className="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-xl text-white focus:outline-none focus:border-amber-500"
                  >
                    <option value="legislacion">Legislaci√≥n</option>
                    <option value="jurisprudencia">Jurisprudencia</option>
                    <option value="doctrina">Doctrina</option>
                    <option value="plantillas">Plantillas</option>
                    <option value="contratos">Contratos</option>
                    <option value="formatos">Formatos</option>
                  </select>
                </div>

                <div>
                  <label className="text-sm text-slate-400 mb-2 block">Etiquetas (separadas por coma)</label>
                  <input
                    type="text"
                    value={uploadForm.tags}
                    onChange={(e) => setUploadForm({...uploadForm, tags: e.target.value})}
                    placeholder="Ej: civil, contratos, modelo"
                    className="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-amber-500"
                  />
                </div>
              </div>

              <div className="flex gap-3 mt-6">
                <button
                  onClick={() => setActiveModal(null)}
                  className="flex-1 py-2.5 border border-slate-700 text-slate-400 rounded-xl hover:text-white transition-colors"
                >
                  Cancelar
                </button>
                <button
                  onClick={handleUpload}
                  className="flex-1 py-2.5 bg-amber-500 text-slate-950 font-medium rounded-xl hover:bg-amber-400 transition-colors flex items-center justify-center gap-2"
                >
                  <Upload className="w-4 h-4" />
                  Subir Documento
                </button>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Modal: Sugerir Documento */}
      <AnimatePresence>
        {activeModal === 'suggest' && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
            onClick={() => setActiveModal(null)}
          >
            <motion.div
              initial={{ scale: 0.95, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.95, opacity: 0 }}
              className="bg-slate-900 border border-slate-800 rounded-2xl p-6 w-full max-w-lg"
              onClick={e => e.stopPropagation()}
            >
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-semibold text-white">Sugerir Nuevo Documento</h3>
                <button onClick={() => setActiveModal(null)} className="p-1 text-slate-400 hover:text-white">
                  <X className="w-5 h-5" />
                </button>
              </div>
              
              <div className="space-y-4">
                <div>
                  <label className="text-sm text-slate-400 mb-2 block">T√≠tulo del documento</label>
                  <input
                    type="text"
                    value={suggestForm.title}
                    onChange={(e) => setSuggestForm({...suggestForm, title: e.target.value})}
                    placeholder="Ej: Nueva jurisprudencia sobre contratos"
                    className="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-amber-500"
                  />
                </div>

                <div>
                  <label className="text-sm text-slate-400 mb-2 block">Categor√≠a</label>
                  <select
                    value={suggestForm.category}
                    onChange={(e) => setSuggestForm({...suggestForm, category: e.target.value})}
                    className="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-xl text-white focus:outline-none focus:border-amber-500"
                  >
                    <option value="legislacion">Legislaci√≥n</option>
                    <option value="jurisprudencia">Jurisprudencia</option>
                    <option value="doctrina">Doctrina</option>
                    <option value="plantillas">Plantillas</option>
                    <option value="contratos">Contratos</option>
                    <option value="formatos">Formatos</option>
                  </select>
                </div>

                <div>
                  <label className="text-sm text-slate-400 mb-2 block">Descripci√≥n / Justificaci√≥n</label>
                  <textarea
                    value={suggestForm.description}
                    onChange={(e) => setSuggestForm({...suggestForm, description: e.target.value})}
                    placeholder="Describe por qu√© este documento ser√≠a √∫til..."
                    rows={4}
                    className="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-amber-500 resize-none"
                  />
                </div>
              </div>

              <div className="flex gap-3 mt-6">
                <button
                  onClick={() => setActiveModal(null)}
                  className="flex-1 py-2.5 border border-slate-700 text-slate-400 rounded-xl hover:text-white transition-colors"
                >
                  Cancelar
                </button>
                <button
                  onClick={handleSuggest}
                  className="flex-1 py-2.5 bg-amber-500 text-slate-950 font-medium rounded-xl hover:bg-amber-400 transition-colors flex items-center justify-center gap-2"
                >
                  <Send className="w-4 h-4" />
                  Enviar Sugerencia
                </button>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Modal: Compartir */}
      <AnimatePresence>
        {activeModal === 'share' && selectedFile && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
            onClick={() => setActiveModal(null)}
          >
            <motion.div
              initial={{ scale: 0.95, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.95, opacity: 0 }}
              className="bg-slate-900 border border-slate-800 rounded-2xl p-6 w-full max-w-md"
              onClick={e => e.stopPropagation()}
            >
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-semibold text-white">Compartir Documento</h3>
                <button onClick={() => setActiveModal(null)} className="p-1 text-slate-400 hover:text-white">
                  <X className="w-5 h-5" />
                </button>
              </div>
              
              <div className="p-4 bg-slate-800/50 rounded-xl mb-4">
                <p className="text-sm text-slate-400">Documento</p>
                <p className="text-white font-medium truncate">{selectedFile.name}</p>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="text-sm text-slate-400 mb-2 block">Compartir por email</label>
                  <div className="flex gap-2">
                    <input
                      type="email"
                      value={shareEmail}
                      onChange={(e) => setShareEmail(e.target.value)}
                      placeholder="correo@ejemplo.com"
                      className="flex-1 px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-amber-500"
                    />
                    <button 
                      onClick={() => setShareEmail('')}
                      className="p-2.5 text-slate-400 hover:text-white"
                    >
                      <X className="w-5 h-5" />
                    </button>
                  </div>
                </div>

                <div className="relative">
                  <div className="absolute inset-0 flex items-center">
                    <div className="w-full border-t border-slate-700"></div>
                  </div>
                  <div className="relative flex justify-center">
                    <span className="px-2 bg-slate-900 text-xs text-slate-500">O</span>
                  </div>
                </div>

                <button
                  onClick={handleCopyLink}
                  className="w-full p-3 bg-slate-800/50 border border-slate-700 rounded-xl hover:border-amber-500/30 transition-colors flex items-center gap-3"
                >
                  <Copy className="w-5 h-5 text-slate-400" />
                  <span className="text-slate-300">{copiedLink ? '¬°Enlace copiado!' : 'Copiar enlace de acceso'}</span>
                  {copiedLink && <Check className="w-4 h-4 text-emerald-500 ml-auto" />}
                </button>
              </div>

              <div className="flex gap-3 mt-6">
                <button
                  onClick={() => setActiveModal(null)}
                  className="flex-1 py-2.5 border border-slate-700 text-slate-400 rounded-xl hover:text-white transition-colors"
                >
                  Cerrar
                </button>
                <button
                  onClick={handleShare}
                  disabled={!shareEmail}
                  className="flex-1 py-2.5 bg-amber-500 text-slate-950 font-medium rounded-xl hover:bg-amber-400 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                  <Share2 className="w-4 h-4" />
                  Compartir
                </button>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Modal: Eliminar */}
      <AnimatePresence>
        {activeModal === 'delete' && selectedFile && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
            onClick={() => setActiveModal(null)}
          >
            <motion.div
              initial={{ scale: 0.95, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.95, opacity: 0 }}
              className="bg-slate-900 border border-slate-800 rounded-2xl p-6 w-full max-w-md"
              onClick={e => e.stopPropagation()}
            >
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-semibold text-white">Eliminar Documento</h3>
                <button onClick={() => setActiveModal(null)} className="p-1 text-slate-400 hover:text-white">
                  <X className="w-5 h-5" />
                </button>
              </div>
              
              <div className="p-4 bg-red-500/10 border border-red-500/20 rounded-xl mb-4">
                <p className="text-sm text-red-400 font-medium mb-2">‚ö†Ô∏è Esta acci√≥n no se puede deshacer</p>
                <p className="text-sm text-slate-400">Documento:</p>
                <p className="text-white truncate">{selectedFile.name}</p>
              </div>

              <p className="text-sm text-slate-400 mb-6">
                ¬øEst√°s seguro de que deseas eliminar este documento permanentemente de la biblioteca?
              </p>

              <div className="flex gap-3">
                <button
                  onClick={() => setActiveModal(null)}
                  className="flex-1 py-2.5 border border-slate-700 text-slate-400 rounded-xl hover:text-white transition-colors"
                >
                  Cancelar
                </button>
                <button
                  onClick={handleDelete}
                  className="flex-1 py-2.5 bg-red-500 text-white font-medium rounded-xl hover:bg-red-400 transition-colors flex items-center justify-center gap-2"
                >
                  <Trash2 className="w-4 h-4" />
                  Eliminar
                </button>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Modal: Editar Metadatos */}
      <AnimatePresence>
        {activeModal === 'edit' && selectedFile && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
            onClick={() => setActiveModal(null)}
          >
            <motion.div
              initial={{ scale: 0.95, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.95, opacity: 0 }}
              className="bg-slate-900 border border-slate-800 rounded-2xl p-6 w-full max-w-lg"
              onClick={e => e.stopPropagation()}
            >
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-semibold text-white">Editar Metadatos</h3>
                <button onClick={() => setActiveModal(null)} className="p-1 text-slate-400 hover:text-white">
                  <X className="w-5 h-5" />
                </button>
              </div>
              
              <div className="space-y-4">
                <div>
                  <label className="text-sm text-slate-400 mb-2 block">Nombre del documento</label>
                  <input
                    type="text"
                    value={editForm.name}
                    onChange={(e) => setEditForm({...editForm, name: e.target.value})}
                    className="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-xl text-white focus:outline-none focus:border-amber-500"
                  />
                </div>

                <div>
                  <label className="text-sm text-slate-400 mb-2 block">Etiquetas (separadas por coma)</label>
                  <input
                    type="text"
                    value={editForm.tags}
                    onChange={(e) => setEditForm({...editForm, tags: e.target.value})}
                    placeholder="Ej: civil, contratos, modelo"
                    className="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-amber-500"
                  />
                </div>

                <div>
                  <label className="text-sm text-slate-400 mb-2 block">Notas / Descripci√≥n</label>
                  <textarea
                    value={editForm.notes}
                    onChange={(e) => setEditForm({...editForm, notes: e.target.value})}
                    rows={4}
                    className="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-amber-500 resize-none"
                  />
                </div>
              </div>

              <div className="flex gap-3 mt-6">
                <button
                  onClick={() => setActiveModal(null)}
                  className="flex-1 py-2.5 border border-slate-700 text-slate-400 rounded-xl hover:text-white transition-colors"
                >
                  Cancelar
                </button>
                <button
                  onClick={handleEdit}
                  className="flex-1 py-2.5 bg-blue-500 text-white font-medium rounded-xl hover:bg-blue-400 transition-colors flex items-center justify-center gap-2"
                >
                  <FileEdit className="w-4 h-4" />
                  Guardar Cambios
                </button>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Modal: Organizar Archivo */}
      <AnimatePresence>
        {activeModal === 'organize' && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
            onClick={() => setActiveModal(null)}
          >
            <motion.div
              initial={{ scale: 0.95, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.95, opacity: 0 }}
              className="bg-slate-900 border border-slate-800 rounded-2xl p-6 w-full max-w-lg"
              onClick={e => e.stopPropagation()}
            >
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-semibold text-white">Organizar Archivo F√≠sico</h3>
                <button onClick={() => setActiveModal(null)} className="p-1 text-slate-400 hover:text-white">
                  <X className="w-5 h-5" />
                </button>
              </div>
              
              <div className="space-y-4">
                <p className="text-sm text-slate-400">
                  Gestiona la ubicaci√≥n f√≠sica de los documentos en el archivo del bufete.
                </p>

                <div className="grid grid-cols-2 gap-3">
                  <button className="p-4 bg-slate-800/50 border border-slate-700 rounded-xl hover:border-amber-500/30 transition-all text-left">
                    <Folder className="w-6 h-6 text-amber-500 mb-2" />
                    <p className="text-sm font-medium text-white">Verificar ubicaci√≥n</p>
                    <p className="text-xs text-slate-500">Comprobar documentos en archivo</p>
                  </button>
                  <button className="p-4 bg-slate-800/50 border border-slate-700 rounded-xl hover:border-amber-500/30 transition-all text-left">
                    <FileSearch className="w-6 h-6 text-blue-500 mb-2" />
                    <p className="text-sm font-medium text-white">Buscar documento</p>
                    <p className="text-xs text-slate-500">Localizar en archivo f√≠sico</p>
                  </button>
                  <button className="p-4 bg-slate-800/50 border border-slate-700 rounded-xl hover:border-amber-500/30 transition-all text-left">
                    <Folder className="w-6 h-6 text-emerald-500 mb-2" />
                    <p className="text-sm font-medium text-white">Nueva ubicaci√≥n</p>
                    <p className="text-xs text-slate-500">Asignar ubicaci√≥n a documento</p>
                  </button>
                  <button className="p-4 bg-slate-800/50 border border-slate-700 rounded-xl hover:border-amber-500/30 transition-all text-left">
                    <Settings className="w-6 h-6 text-purple-500 mb-2" />
                    <p className="text-sm font-medium text-white">Inventario</p>
                    <p className="text-xs text-slate-500">Revisar inventario completo</p>
                  </button>
                </div>
              </div>

              <div className="flex gap-3 mt-6">
                <button
                  onClick={() => setActiveModal(null)}
                  className="flex-1 py-2.5 border border-slate-700 text-slate-400 rounded-xl hover:text-white transition-colors"
                >
                  Cerrar
                </button>
                <button
                  onClick={handleOrganize}
                  className="flex-1 py-2.5 bg-emerald-500 text-slate-950 font-medium rounded-xl hover:bg-emerald-400 transition-colors flex items-center justify-center gap-2"
                >
                  <CheckCircle className="w-4 h-4" />
                  Marcar como Organizado
                </button>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Modal: Ver Documento */}
      <AnimatePresence>
        {activeModal === 'view' && selectedFile && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"
            onClick={() => setActiveModal(null)}
          >
            <motion.div
              initial={{ scale: 0.95, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.95, opacity: 0 }}
              className="bg-slate-900 border border-slate-800 rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden"
              onClick={e => e.stopPropagation()}
            >
              <div className="flex items-center justify-between p-4 border-b border-slate-800">
                <div className="flex items-center gap-3">
                  <FileText className="w-6 h-6 text-amber-500" />
                  <div>
                    <h3 className="text-lg font-semibold text-white">{selectedFile.name}</h3>
                    <p className="text-xs text-slate-400">{selectedFile.size} ‚Ä¢ {selectedFile.modified}</p>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <button 
                    onClick={() => handleDownload(selectedFile)}
                    className="flex items-center gap-2 px-3 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700"
                  >
                    <Download className="w-4 h-4" />
                    <span className="text-sm">Descargar</span>
                  </button>
                  <button onClick={() => setActiveModal(null)} className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg">
                    <X className="w-5 h-5" />
                  </button>
                </div>
              </div>
              
              <div className="p-8 flex items-center justify-center min-h-[400px] bg-slate-950">
                <div className="text-center">
                  <FileText className="w-24 h-24 text-slate-700 mx-auto mb-4" />
                  <p className="text-slate-500 mb-2">Vista previa del documento</p>
                  <p className="text-sm text-slate-600">{selectedFile.name}</p>
                  <p className="text-xs text-slate-500 mt-4 max-w-md">{selectedFile.notes}</p>
                  <div className="flex flex-wrap gap-2 justify-center mt-4">
                    {selectedFile.tags.map((tag) => (
                      <span key={tag} className="px-2 py-1 bg-slate-800 text-slate-400 text-xs rounded-full">{tag}</span>
                    ))}
                  </div>
                </div>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Modal: Firma Electr√≥nica */}
      <SignatureModal
        isOpen={signatureModalOpen}
        onClose={() => setSignatureModalOpen(false)}
        mode={signatureMode}
        documentId={selectedFile?.id?.toString() || ''}
        documentName={selectedFile?.name || ''}
        onComplete={(result) => {
          if (signatureMode === 'request') {
            showToast(`Solicitud de firma enviada para ${selectedFile?.name}`, 'success');
          } else {
            showToast(`Documento firmado correctamente`, 'success');
          }
          setSignatureModalOpen(false);
        }}
      />
    </AppLayout>
  );
}
